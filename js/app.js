!function(){"use strict;";for(var topPanel=$("#topPanel"),title=$("#title"),topRightPanel=$("#topRightPanel"),elementVal=$("#element"),topVal=$("#top"),leftVal=$("#left"),conditions=$("#conditions"),centerElementBtn=$("#center button"),selectedElement=null,canvasContainerId="parentDiv",width=$(`#${canvasContainerId}`).innerWidth(),height=$(`#${canvasContainerId}`).innerHeight(),blockSnapSize=15,spacing=3*blockSnapSize,xStart=3*blockSnapSize,yStart=12*blockSnapSize,widthLinePosXStart=xStart,widthLinePosYStart=yStart-16,containerTextOffset=8,layer=new Konva.Layer,stage=new Konva.Stage({container:"parentDiv",width:width,height:height}),gridLayer=new Konva.Layer,padding=blockSnapSize,i=0;i<width/padding;i++)gridLayer.add(new Konva.Line({points:[Math.round(i*padding)+.5,0,Math.round(i*padding)+.5,height],stroke:"#ddd",strokeWidth:1}));gridLayer.add(new Konva.Line({points:[0,0,10,10]}));for(var j=0;j<height/padding;j++)gridLayer.add(new Konva.Line({points:[0,Math.round(j*padding),width,Math.round(j*padding)],stroke:"#ddd",strokeWidth:.5}));function calculateTopVal(t,e){return Math.abs(t-e)/blockSnapSize+"'"}function calculateLeftVal(t,e){return Math.abs(t-e)/blockSnapSize+"'"}function calculateWidth(t,e,a,n,i){var o;return"Top"!==t&&"Right"!==t&&"Left"!==t||(o=n*blockSnapSize),"Front"!==t&&"Rear"!==t||(o=e*blockSnapSize),o}function calculateHeight(t,e,a,n,i){var o;return"Top"===t&&(o=e*blockSnapSize),"Right"!==t&&"Left"!==t&&"Front"!==t&&"Rear"!==t||(o=a*blockSnapSize),o}function calculateXPos(t,e,a,n,i){var o;return"Top"!==t&&"Right"!==t&&"Left"!==t||(o=xStart),"Front"!==t&&"Rear"!==t||(o=xStart+n*blockSnapSize+spacing),o}function calculateYPos(t,e,a,n,i){var o;return"Top"===t&&(o=yStart),"Right"!==t&&"Front"!==t||(o=e*blockSnapSize+spacing+yStart),"Left"!==t&&"Rear"!==t||(o=2*e*blockSnapSize+2*spacing+yStart),o}function fitStageIntoParentContainer(){var t=document.querySelector("#parentDiv").offsetWidth/width;stage.width(width*t),stage.height(height*t),stage.scale({x:t,y:t}),stage.draw()}stage.add(gridLayer),stage.add(layer),$("#componentItems").on("click",".single_item",function(){var disabledOn=$(this).attr("disabled-on").split(","),imageObj=new Image,componentName=$(this).attr("component-name"),imageWidth,imageHeight;imageObj.src=$(this).find("img").attr("src"),imageObj.onload=function(){imageWidth=imageObj.width,imageHeight=imageObj.height;var disabledContainers=layer.getChildren(function(t){return"container"===t.getAttr("as")&&disabledOn.includes(t.getAttr("containerType"))}),enabledContainers=layer.getChildren(function(t){return"container"===t.getAttr("as")&&!disabledOn.includes(t.getAttr("containerType"))}),currPosition,prevPosition;console.log(enabledContainers);var yoda=new Konva.Image({as:"component",componentName:componentName,containerId:0,x:enabledContainers[0].attrs.x+blockSnapSize,y:enabledContainers[0].attrs.y+blockSnapSize,containerX:enabledContainers[0].attrs.x,containerY:enabledContainers[0].attrs.y,containerWidth:enabledContainers[0].attrs.width,containerHeight:enabledContainers[0].attrs.height,image:imageObj,width:imageWidth,height:imageHeight,draggable:!0,stroke:"#fecd00",strokeWidth:0,dragBoundFunc:function(pos){var x=0,y=0,condition="";return enabledContainers.forEach((t,e)=>{0===e&&(condition=condition.concat(`\n                                if(\n                                pos.x >= enabledContainers[${e}].attrs.x &&\n                                pos.x + imageWidth <\n                                    enabledContainers[${e}].attrs.width +\n                                        enabledContainers[${e}].attrs.x &&\n                                pos.y >= enabledContainers[${e}].attrs.y &&\n                                pos.y + imageHeight <\n                                    enabledContainers[${e}].attrs.height +\n                                        enabledContainers[${e}].attrs.y\n                                        ){ \n                                            currPostion = ${e};\n                                        }`)),e>0&&(condition=condition.concat(`else if(\n                                pos.x >= enabledContainers[${e}].attrs.x &&\n                                pos.x + imageWidth <\n                                    enabledContainers[${e}].attrs.width +\n                                        enabledContainers[${e}].attrs.x &&\n                                pos.y >= enabledContainers[${e}].attrs.y &&\n                                pos.y + imageHeight <\n                                    enabledContainers[${e}].attrs.height +\n                                        enabledContainers[${e}].attrs.y\n                                ){\n                                    currPostion = ${e};\n                                }`))}),currPosition=eval(condition),x=pos.x,y=pos.y,enabledContainers.forEach((t,e)=>{currPosition===e&&(prevPosition=e,yoda.setAttrs({containerId:e,containerX:enabledContainers[e].attrs.x,containerY:enabledContainers[e].attrs.y,containerWidth:enabledContainers[e].attrs.width,containerHeight:enabledContainers[e].attrs.height})),prevPosition===e&&(pos.x<enabledContainers[e].attrs.x&&(x=enabledContainers[e].attrs.x),pos.x+imageWidth>=enabledContainers[e].attrs.width+enabledContainers[e].attrs.x&&(x=enabledContainers[e].attrs.width+enabledContainers[e].attrs.x-imageWidth),pos.y<enabledContainers[e].attrs.y&&(y=enabledContainers[e].attrs.y),pos.y+imageHeight>=enabledContainers[e].attrs.height+enabledContainers[e].attrs.y&&(y=enabledContainers[e].attrs.height+enabledContainers[e].attrs.y-imageHeight))}),{x:x,y:y}}}),disabledVisuals=[];disabledContainers.forEach((t,e)=>{disabledVisuals[e]=new Konva.Rect({x:t.attrs.x,y:t.attrs.y,width:t.attrs.width,height:t.attrs.height,fill:"#cccccc",opacity:.8,strokeWidth:2,dash:[20,2]})});var imgShadow=new Konva.Rect({x:0,y:0,width:imageWidth,height:imageHeight,fill:"#ffeea8",opacity:.6,stroke:"#fecd00",strokeWidth:2,dash:[20,2]});yoda.on("click",()=>{layer.getChildren(function(t){return"component"===t.getAttr("as")}).forEach(t=>{t.setAttrs({strokeWidth:0})}),elementVal.html(yoda.attrs.componentName),topVal.html(calculateTopVal(yoda.attrs.containerY,yoda.attrs.y)),leftVal.html(calculateLeftVal(yoda.attrs.containerX,yoda.attrs.x)),selectedElement=yoda,yoda.setAttrs({strokeWidth:2}),layer.batchDraw()}),yoda.on("dragstart",t=>{layer.getChildren(function(t){return"component"===t.getAttr("as")}).forEach(t=>{t.setAttrs({strokeWidth:0})}),imgShadow.show(),imgShadow.moveToTop(),yoda.moveToTop(),disabledVisuals.forEach(t=>{t.show()}),elementVal.html(yoda.attrs.componentName),topVal.html(calculateTopVal(yoda.attrs.containerY,yoda.attrs.y)),leftVal.html(calculateLeftVal(yoda.attrs.containerX,yoda.attrs.x)),selectedElement=yoda,yoda.setAttrs({strokeWidth:2}),layer.batchDraw()}),yoda.on("dragend",t=>{yoda.position({x:Math.round(yoda.x()/blockSnapSize)*blockSnapSize,y:Math.round(yoda.y()/blockSnapSize)*blockSnapSize}),imgShadow.hide(),disabledVisuals.forEach(t=>{t.hide()}),topVal.html(calculateTopVal(yoda.attrs.containerY,yoda.attrs.y)),leftVal.html(calculateLeftVal(yoda.attrs.containerX,yoda.attrs.x)),selectedElement=yoda,stage.batchDraw()}),yoda.on("dragmove",t=>{imgShadow.position({x:Math.round(yoda.x()/blockSnapSize)*blockSnapSize,y:Math.round(yoda.y()/blockSnapSize)*blockSnapSize}),stage.batchDraw()}),imgShadow.hide(),layer.add(imgShadow),layer.add(yoda),disabledVisuals.forEach(t=>{t.hide(),layer.add(t)}),layer.batchDraw()}}),$("#containerItems").on("click",".container-item",function(){layer.destroyChildren(),selectedElement=null,conditions.find("[data='new']").hide().find("input").attr("checked",!1),conditions.find("[data='used']").hide().find("input").attr("checked",!1),elementVal.html("..."),topVal.html("..."),leftVal.html("...");var t=$(this).attr("key"),e=$(this).find("a").html(),a=$(this).attr("folder-id"),n=$(this).attr("width"),i=$(this).attr("height"),o=$(this).attr("length"),r=containersData[t].condition.new,d=containersData[t].condition.used;r&&conditions.find("[data='new']").show(),d&&conditions.find("[data='used']").show(),["Top","Right","Left","Front","Rear"].forEach(t=>{window[`containerImage${t}`]=new Image,window[`containerImage${t}`].src=`./images/containers/${a}/${t.toLowerCase()}.svg`,window[`containerImage${t}`].onload=function(){window[`containerItem${t}`]=new Konva.Image({as:"container",containerType:t,x:calculateXPos(t,n,i,o,`containerImage${t}`),y:calculateYPos(t,n,i,o,`containerImage${t}`),image:window[`containerImage${t}`],width:calculateWidth(t,n,i,o,`containerImage${t}`),height:calculateHeight(t,n,i,o,`containerImage${t}`)}),window[`containerItemText${t}`]=new Konva.Text({as:"container",containerType:t,x:calculateXPos(t,n,i,o,`containerImage${t}`),y:calculateYPos(t,n,i,o,`containerImage${t}`)+("Top"===t?n:i)*blockSnapSize+containerTextOffset,text:`${t} view`}),layer.add(window[`containerItem${t}`]),layer.add(window[`containerItemText${t}`]),layer.batchDraw()}}),title.html(e),topPanel.show(),topRightPanel.show(),centerElementBtn.on("click",function(){selectedElement.position({x:selectedElement.attrs.containerWidth/2+selectedElement.attrs.containerX-selectedElement.attrs.width/2,y:selectedElement.attrs.containerHeight/2+selectedElement.attrs.containerY-selectedElement.attrs.height/2}),topVal.html(calculateTopVal(selectedElement.attrs.containerY,selectedElement.attrs.y)),leftVal.html(calculateLeftVal(selectedElement.attrs.containerX,selectedElement.attrs.x)),layer.batchDraw()}),stage.on("click",function(t){layer.getChildren(function(t){return"component"===t.getAttr("as")}).forEach(t=>{t.setAttrs({strokeWidth:0})}),"component"===t.target.attrs.as&&t.target.setAttrs({strokeWidth:2}),layer.batchDraw()})}),fitStageIntoParentContainer(),window.addEventListener("resize",fitStageIntoParentContainer)}();